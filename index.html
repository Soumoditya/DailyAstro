<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astro - Debug Mode</title>
    
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #d35400; }
        button { background: #d35400; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; border-radius: 4px; width: 100%; }
        button:hover { background: #e67e22; }
        input { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ccc; }
        
        /* DEBUG CONSOLE STYLES */
        #debug-console {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 30px;
            height: 200px;
            overflow-y: scroll;
            border: 2px solid #333;
        }
        .log-err { color: #ff3333; font-weight: bold; }
        .log-warn { color: #ffff33; }
        .log-info { color: #00ccff; }
        .status-good { color: green; font-weight: bold; }
        .status-bad { color: red; font-weight: bold; }
    </style>

    <script>
        function log(msg, type="info") {
            const consoleBox = document.getElementById('debug-console');
            if(consoleBox) {
                const line = document.createElement('div');
                line.textContent = `> ${msg}`;
                if(type === 'error') line.className = 'log-err';
                if(type === 'warn') line.className = 'log-warn';
                consoleBox.appendChild(line);
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`CRASH: ${message} (Line: ${lineno})`, 'error');
            return false;
        };
    </script>
</head>
<body>

    <h1>üïâÔ∏è Vedic Guide (System Check)</h1>

    <div class="card">
        <h2>üìÖ Today's Status</h2>
        <div id="panchang-content">Loading...</div>
    </div>

    <div class="card">
        <h2>‚úÇÔ∏è Grooming</h2>
        <div id="grooming-result">Loading...</div>
    </div>

    <div class="card">
        <h2>üîÆ Personal Prediction</h2>
        <label>Date of Birth:</label>
        <input type="date" id="dob">
        <label>Time of Birth:</label>
        <input type="time" id="tob" value="12:00">
        <button onclick="runPersonalCalc()">Get Prediction</button>
        <div id="personal-result" style="margin-top:15px; font-weight:bold;"></div>
    </div>

    <h3>üîß System Logs (Tell me what this says if it fails)</h3>
    <div id="debug-console">
        <div>System initialized...</div>
    </div>

    <script>
        log("Attempting to load Astronomy Engine...", "info");
    </script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js" 
            onload="log('Library loaded successfully.', 'info'); initApp();" 
            onerror="log('FAILED to load Library from CDN. Check Internet.', 'error');">
    </script>

    <script>
        // --- DATA ---
        const nakshatras = ["Ashwini","Bharani","Krittika","Rohini","Mrigashira","Ardra","Punarvasu","Pushya","Ashlesha","Magha","Purva Phalguni","Uttara Phalguni","Hasta","Chitra","Swati","Vishakha","Anuradha","Jyeshtha","Mula","Purva Ashadha","Uttara Ashadha","Shravana","Dhanishta","Shatabhisha","Purva Bhadrapada","Uttara Bhadrapada","Revati"];
        const tithis = ["Prathama","Dwitiya","Tritiya","Chaturthi","Panchami","Shashthi","Saptami","Ashtami","Navami","Dashami","Ekadashi","Dwadashi","Trayodashi","Chaturdashi","Purnima/Amavasya"];

        let globalTodayData = null;

        // --- CORE FUNCTIONS ---
        function initApp() {
            log("Starting calculations...", "info");
            try {
                if (typeof Astronomy === 'undefined') {
                    throw new Error("Astronomy object is missing.");
                }
                
                const now = new Date();
                log(`Current Time: ${now.toString()}`, "info");

                globalTodayData = calculateVedic(now);
                
                if (globalTodayData) {
                    displayPanchang(globalTodayData);
                    checkGrooming(globalTodayData);
                    log("App running successfully.", "info");
                }
            } catch (e) {
                log(e.message, 'error');
            }
        }

        function calculateVedic(dateObj) {
            log(`Calculating for date: ${dateObj.toDateString()}`);
            
            // 1. Get Positions
            // Using Geocentric Observer (Latitude 0, Longitude 0) to avoid location errors
            const observer = Astronomy.MakeObserver(0, 0, 0);
            const moonEq = Astronomy.Equator("Moon", dateObj, observer, true, true);
            const sunEq = Astronomy.Equator("Sun", dateObj, observer, true, true);
            
            // 2. Convert to Ecliptic
            const moonLon = Astronomy.Ecliptic(moonEq).lon;
            const sunLon = Astronomy.Ecliptic(sunEq).lon;

            // 3. Apply Ayanamsa (Approx Lahiri)
            const year = dateObj.getFullYear();
            const ayanamsa = 23.85 + ((year - 2000) * 0.0139);
            
            let vMoon = (moonLon - ayanamsa + 360) % 360;
            let vSun = (sunLon - ayanamsa + 360) % 360;

            // 4. Nakshatra
            const nakIndex = Math.floor(vMoon / 13.33333);
            
            // 5. Tithi
            let diff = vMoon - vSun;
            if (diff < 0) diff += 360;
            const tithiIndex = Math.floor(diff / 12);

            log(`Calculated: Nak Index ${nakIndex}, Tithi Index ${tithiIndex}`);

            return {
                nakIndex: nakIndex,
                nakName: nakshatras[nakIndex % 27],
                tithiIndex: tithiIndex,
                tithiName: tithis[tithiIndex % 15],
                weekday: dateObj.getDay()
            };
        }

        function displayPanchang(data) {
            const html = `
                <b>Tithi:</b> ${data.tithiName}<br>
                <b>Nakshatra:</b> ${data.nakName}<br>
                <b>Weekday:</b> ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][data.weekday]}
            `;
            document.getElementById('panchang-content').innerHTML = html;
        }

        function checkGrooming(data) {
            let reasons = [];
            let bad = false;

            // Weekday
            if (data.weekday === 2) { bad = true; reasons.push("Tuesday (Avoid)"); }
            if (data.weekday === 6) { bad = true; reasons.push("Saturday (Avoid)"); }
            if (data.weekday === 4) { bad = true; reasons.push("Thursday (Avoid)"); }

            // Tithi (Rikta 4,9,14 & 15,30)
            let tVal = (data.tithiIndex % 15) + 1;
            if ([4,9,14].includes(tVal)) { bad = true; reasons.push("Rikta Tithi"); }
            if (data.tithiIndex === 14) { bad = true; reasons.push("Purnima"); }
            if (data.tithiIndex === 29) { bad = true; reasons.push("Amavasya"); }

            const el = document.getElementById('grooming-result');
            if (bad) {
                el.innerHTML = `<span class="status-bad">‚õî NO / AVOID</span><br><small>${reasons.join(", ")}</small>`;
            } else {
                el.innerHTML = `<span class="status-good">‚úÖ YES / GOOD</span><br><small>Favourable energy.</small>`;
            }
        }

        function runPersonalCalc() {
            log("Running personal calc...");
            const d = document.getElementById('dob').value;
            const t = document.getElementById('tob').value;

            if(!d || !t) {
                log("User input missing", "warn");
                alert("Please enter Birth Date & Time");
                return;
            }

            try {
                const birthDate = new Date(d + "T" + t);
                const birthData = calculateVedic(birthDate);
                
                // Tara Bala
                // (TodayStar - BirthStar) + 27 % 9
                // If remainder is 1, 3, 5, 7 = Bad.
                let diff = (globalTodayData.nakIndex - birthData.nakIndex) + 27;
                let count = (diff % 27) + 1; 
                let tara = count % 9;
                
                // 1=Janma(Bad), 2=Sampat(Good), 3=Vipat(Bad), 4=Kshema(Good), 5=Pratyak(Bad), 6=Sadhana(Good), 7=Naidhana(Bad), 8=Mitra(Good), 0(9)=ParamaMitra(Good)
                
                let isGood = true;
                let type = "";
                
                switch(tara) {
                    case 1: type="Janma (Birth - Sensitive)"; isGood=false; break;
                    case 2: type="Sampat (Wealth - Very Good)"; break;
                    case 3: type="Vipat (Danger - Bad)"; isGood=false; break;
                    case 4: type="Kshema (Safety - Good)"; break;
                    case 5: type="Pratyak (Obstacle - Bad)"; isGood=false; break;
                    case 6: type="Sadhana (Success - Good)"; break;
                    case 7: type="Naidhana (Destruction - Very Bad)"; isGood=false; break;
                    case 8: type="Mitra (Friend - Good)"; break;
                    case 0: type="Parama Mitra (Best Friend - Good)"; break;
                }

                const resEl = document.getElementById('personal-result');
                if(isGood) {
                    resEl.innerHTML = `Your Star: ${birthData.nakName}<br><span class="status-good">${type}</span>`;
                } else {
                    resEl.innerHTML = `Your Star: ${birthData.nakName}<br><span class="status-bad">${type}</span>`;
                }
                log("Personal calc success.", "info");

            } catch(e) {
                log("Personal calc failed: " + e.message, "error");
            }
        }
    </script>
</body>
</html>
